<ng-container *transloco="let t; prefix: 'pdf-reader'">
  @if (accountService.currentUser$ | async; as user) {
    <div class="{{theme}}" [class.immersive-active]="immersiveMode" #container>

      @if (isLoading && !disableLoadingIndicator()) {
        <div class="loading-message-container">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          {{t('loading-message')}}
        </div>
        <div class="progress-container row g-0 align-items-center">
          <div class="progress" style="height: 5px;">
            <div class="progress-bar" role="progressbar" [ngStyle]="{'width': loadPercent + '%'}" [attr.aria-valuenow]="loadPercent" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      }

      <ngx-extended-pdf-viewer #pdfViewer
        [src]="readerService.downloadPdf(this.chapterId)"
        [authorization]="user.token ? 'Bearer ' + user.token : ''"
        height="100vh"
        [(page)]="currentPage"
        [textLayer]="true"
        [showHandToolButton]="true"
        [showOpenFileButton]="false"
        [showPrintButton]="false"
        [showRotateButton]="false"
        [showDownloadButton]="false"
        [showPropertiesButton]="false"
        [(zoom)]="zoomSetting"
        [showSecondaryToolbarButton]="true"
        [showBorders]="true"
        [theme]="theme"
        [backgroundColor]="backgroundColor"
        [customToolbar]="multiToolbar"
        [language]="user.preferences.locale"

        [(scrollMode)]="scrollMode"
        [pageViewMode]="pageLayoutMode"
        [spread]="spreadMode"

        (pageChange)="saveProgress()"
        (pdfLoadingStarts)="updateLoading(true)"
        (pdfLoaded)="updateLoading(false)"
        (progress)="updateLoadProgress($event)"
        (zoomChange)="calcScrollbarNeeded()"
        (findbarVisibleChange)="updateSearchOpen($event)"
       />

      @if (scrollMode === ScrollModeType.page && !isLoading) {
        @if (!isSearchOpen) {
          <div class="left" (click)="prevPage()"></div>
          <div class="{{scrollbarNeeded ? 'right-with-scrollbar' : 'right'}}" (click)="nextPage()"></div>
        }
      }

      <ng-template #multiToolbar>
        <div style="min-height: 36px" id="toolbarViewer" [ngStyle]="{'background-color': backgroundColor, 'color': fontColor}">
          <div id="toolbarViewerLeft">
            <pdf-toggle-sidebar />
            <pdf-find-button [textLayer]='true' />
            <pdf-paging-area />

            @if (breakpointService.isTabletOrAbove()) {
              <button class="btn-icon mt-0 mb-0 pt-1 pb-0 toolbarButton" [ngbTooltip]="bookTitle">
                <i class="toolbar-icon fa-solid fa-info" [ngStyle]="{color: fontColor}" aria-hidden="true"></i>
                <span class="visually-hidden">{{bookTitle}}</span>
              </button>
            }

            @if (incognitoMode) {
              <button [ngbTooltip]="t('toggle-incognito')" (click)="turnOffIncognito()" class="btn-icon mt-0 mb-0 pt-1 pb-0 toolbarButton">
                <i class="toolbar-icon fa fa-glasses" [ngStyle]="{color: fontColor}" aria-hidden="true"></i>
                <span class="visually-hidden">{{t('incognito-mode')}}</span>
              </button>
            }

            <button class="btn-icon col-2 col-xs-1 mt-0 mb-0 pt-1 pb-0 toolbarButton" (click)="closeReader()" [ngbTooltip]="t('close-reader-alt')">
              <i class="toolbar-icon fa fa-times-circle" aria-hidden="true" [ngStyle]="{color: fontColor}"></i>
              <span class="visually-hidden">{{t('close-reader-alt')}}</span>
            </button>
          </div>

          <pdf-zoom-toolbar />


          <div id="toolbarViewerRight">
            <button (click)="toggleImmersiveMode()" class="btn-icon toolbarButton" [ngbTooltip]="t('immersive-mode-alt')">
              <i class="toolbar-icon fa-solid fa-up-right-and-down-left-from-center" [ngStyle]="{color: fontColor}" aria-hidden="true"></i>
              <span class="visually-hidden">{{t('immersive-mode-alt')}}</span>
            </button>
          </div>

        </div>

      </ng-template>
    </div>

    <!-- Immersive mode controls - placed outside container to avoid zoom transforms -->
    @if (immersiveMode) {
      <div class="immersive-controls">
        <button class="immersive-btn" (click)="zoomOut()" [attr.aria-label]="t('zoom-out-alt')">
          <i class="fa-solid fa-minus"></i>
        </button>
        <button class="immersive-btn" (click)="zoomIn()" [attr.aria-label]="t('zoom-in-alt')">
          <i class="fa-solid fa-plus"></i>
        </button>
        <button class="immersive-btn immersive-exit-btn" (click)="toggleImmersiveMode()" [attr.aria-label]="t('exit-immersive-alt')">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    }
  }

</ng-container>
